#include <thread>

#include "spjalla/core/client.h"
#include "spjalla/plugins/slashdot.h"
#include "spjalla/ui/basic_window.h"
#include "spjalla/lines/basic.h"

namespace spjalla::plugins {
	void slashdot_plugin::postinit(plugin_host *host) {
		parent = dynamic_cast<spjalla::client *>(host);
		if (!parent) { DBG("Error: expected client as plugin host"); return; }

		parent->add(".", 0, 0, false, [this](pingpong::server *, const input_line &) {
			std::thread thread([this]() {
				// std::string raw = R"(<backslash xmlns:backslash="https://slashdot.org/backslash.dtd"> <script/> <story> <title> Sony Announces Plan To Publish PlayStation Games On Non-PS Consoles </title> <url> https://slashdot.org/story/19/12/10/2336221/sony-announces-plan-to-publish-playstation-games-on-non-ps-consoles </url> <time>2019-12-11 02:00:00</time> <author>BeauHD</author> <department>share-the-love</department> <topic>394</topic> <comments>0</comments> <section>games</section> <image>playstation_64.png</image> </story> <story> <title>Nikon Is Killing Its Authorized Repair Program</title> <url> https://slashdot.org/story/19/12/10/2237225/nikon-is-killing-its-authorized-repair-program </url> <time>2019-12-11 01:30:00</time> <author>BeauHD</author> <department>more-than-a-little-inconvenient</department> <topic>84</topic> <comments>7</comments> <section>technology</section> <image>business_64.png</image> </story> <story> <title> Vietnam's Richest Man Bets $2 Billion To Sell Cars To Americans </title> <url> https://slashdot.org/story/19/12/10/2228203/vietnams-richest-man-bets-2-billion-to-sell-cars-to-americans </url> <time>2019-12-11 00:50:00</time> <author>BeauHD</author> <department>ambitious-goals</department> <topic>1971</topic> <comments>9</comments> <section>technology</section> <image>transportation_64.png</image> </story> <story> <title> Chrome Now Warns You When Your Password Has Been Stolen </title> <url> https://slashdot.org/story/19/12/10/2221225/chrome-now-warns-you-when-your-password-has-been-stolen </url> <time>2019-12-11 00:10:00</time> <author>BeauHD</author> <department>better-password-protections</department> <topic>10103</topic> <comments>14</comments> <section>yro</section> <image>chrome_64.png</image> </story> <story> <title> Facebook Fired a Contractor Who Was Paid Thousands In Bribes To Reactivate Banned Ad Accounts </title> <url> https://slashdot.org/story/19/12/10/227229/facebook-fired-a-contractor-who-was-paid-thousands-in-bribes-to-reactivate-banned-ad-accounts </url> <time>2019-12-10 23:30:00</time> <author>BeauHD</author> <department>shady-business</department> <topic>48197</topic> <comments>8</comments> <section>technology</section> <image>facebook_64.png</image> </story> <story> <title> New Plundervolt Attack Impacts Intel Desktop, Server, and Mobile CPUs </title> <url> https://slashdot.org/story/19/12/10/2155231/new-plundervolt-attack-impacts-intel-desktop-server-and-mobile-cpus </url> <time>2019-12-10 22:50:00</time> <author>BeauHD</author> <department>secure-until-proven-otherwise</department> <topic>76</topic> <comments>15</comments> <section>it</section> <image>security_64.png</image> </story> <story> <title>Microsoft Teams is the First Office App For Linux</title> <url> https://slashdot.org/story/19/12/10/1715255/microsoft-teams-is-the-first-office-app-for-linux </url> <time>2019-12-10 22:10:00</time> <author>msmash</author> <department>marching-ahead</department> <topic>11</topic> <comments>28</comments> <section>linux</section> <image>microsoft_64100.png</image> </story> <story> <title> Architects Are Playing With the Future of Design in Video Games </title> <url> https://slashdot.org/story/19/12/10/1935235/architects-are-playing-with-the-future-of-design-in-video-games </url> <time>2019-12-10 21:31:00</time> <author>msmash</author> <department>moving-forward</department> <topic>64</topic> <comments>15</comments> <section>games</section> <image>games_64.png</image> </story> <story> <title>Iran's Internet Freedom is On Life Support</title> <url> https://slashdot.org/story/19/12/10/1558259/irans-internet-freedom-is-on-life-support </url> <time>2019-12-10 20:50:00</time> <author>msmash</author> <department>meanwhile-elsewhere-in-the-world</department> <topic>60</topic> <comments>42</comments> <section>yro</section> <image>censorship_64.png</image> </story> <story> <title> Google Releases Chrome 79 With New Features Including an Option To Freeze Tabs and Back-Forward Caching </title> <url> https://slashdot.org/story/19/12/10/1959205/google-releases-chrome-79-with-new-features-including-an-option-to-freeze-tabs-and-back-forward-caching </url> <time>2019-12-10 20:10:00</time> <author>msmash</author> <department>browser-updates</department> <topic>10103</topic> <comments>20</comments> <section>yro</section> <image>chrome_64.png</image> </story> <story> <title> Are You One Of Avast's 400 Million Users? This Is Why It Collects And Sells Your Web Habits. </title> <url> https://slashdot.org/story/19/12/10/1922243/are-you-one-of-avasts-400-million-users-this-is-why-it-collects-and-sells-your-web-habits </url> <time>2019-12-10 19:30:00</time> <author>msmash</author> <department>show-me-the-money</department> <topic>76</topic> <comments>16</comments> <section>it</section> <image>security_64.png</image> </story> <story> <title> Greeks Set To Face Heavy Fines If They Don't Spend 30% of Their Income Electronically </title> <url> https://slashdot.org/story/19/12/10/1614216/greeks-set-to-face-heavy-fines-if-they-dont-spend-30-of-their-income-electronically </url> <time>2019-12-10 18:50:00</time> <author>msmash</author> <department>stranger-things</department> <topic>253</topic> <comments>103</comments> <section>news</section> <image>money_64.png</image> </story> <story> <title>The Death of the Paper Ticket For Sporting Events</title> <url> https://slashdot.org/story/19/12/10/163220/the-death-of-the-paper-ticket-for-sporting-events </url> <time>2019-12-10 18:10:00</time> <author>msmash</author> <department>closer-look</department> <topic>84</topic> <comments>73</comments> <section>slashdot</section> <image>business_64.png</image> </story> <story> <title> Google Built Its Own Tiny HDMI 2.1 Box To Jump-Start 'the Next Generation of Android TV' </title> <url> https://slashdot.org/story/19/12/10/1713257/google-built-its-own-tiny-hdmi-21-box-to-jump-start-the-next-generation-of-android-tv </url> <time>2019-12-10 17:30:00</time> <author>msmash</author> <department>for-what-it-is-worth</department> <topic>14</topic> <comments>18</comments> <section>technology</section> <image>google_64.png</image> </story> <story> <title> Facebook Tells US Attorney General It's Not Prepared To Get Rid Of Encryption On WhatsApp And Messenger </title> <url> https://slashdot.org/story/19/12/10/1555243/facebook-tells-us-attorney-general-its-not-prepared-to-get-rid-of-encryption-on-whatsapp-and-messenger </url> <time>2019-12-10 16:50:00</time> <author>msmash</author> <department>tussle-continues</department> <topic>537</topic> <comments>100</comments> <section>it</section> <image>encryption_64.png</image> </story> </backslash>)";
				std::string raw = R"(<backslash xmlns:backslash="https://slashdot.org/backslash.dtd"> <script/> <story> <title>The Struggle To Name Lab-Grown Meat</title> <url> https://slashdot.org/story/19/12/17/0010205/the-struggle-to-name-lab-grown-meat </url> <time>2019-12-17 01:50:00</time> <author>BeauHD</author> <department>time-to-decide</department> <topic>350</topic> <comments>0</comments> <section>science</section> <image>biotech_64.png</image> </story> <story> <title> Visa Warns That Hackers Are Scraping Card Details From Gas Pumps </title> <url> https://slashdot.org/story/19/12/16/229247/visa-warns-that-hackers-are-scraping-card-details-from-gas-pumps </url> <time>2019-12-17 01:20:00</time> <author>BeauHD</author> <department>what-else-is-new</department> <topic>253</topic> <comments>7</comments> <section>news</section> <image>money_64.png</image> </story> <story> <title> New Jersey's Largest Hospital System Pays Up In Ransomware Attack </title> <url> https://slashdot.org/story/19/12/16/221230/new-jerseys-largest-hospital-system-pays-up-in-ransomware-attack </url> <time>2019-12-17 00:50:00</time> <author>BeauHD</author> <department>giving-in-to-demands</department> <topic>76</topic> <comments>9</comments> <section>science</section> <image>security_64.png</image> </story> <story> <title> Nuclear Fusion Startup Raises $100 Million To Design and Build a Demo Power Plant </title> <url> https://slashdot.org/story/19/12/16/2155259/nuclear-fusion-startup-raises-100-million-to-design-and-build-a-demo-power-plant </url> <time>2019-12-17 00:10:00</time> <author>BeauHD</author> <department>power-of-the-future</department> <topic>154</topic> <comments>37</comments> <section>hardware</section> <image>power_64.png</image> </story> <story> <title> Ask Slashdot: Who Is Most Likely To Challenge Microsoft In the Office? </title> <url> https://slashdot.org/story/19/12/16/2147205/ask-slashdot-who-is-most-likely-to-challenge-microsoft-in-the-office </url> <time>2019-12-16 23:30:00</time> <author>BeauHD</author> <department>office-space</department> <topic>14</topic> <comments>44</comments> <section>askslashdot</section> <image>google_64.png</image> </story> <story> <title> Amazon Blocks Sellers From Using FedEx Ground For Prime Shipments </title> <url> https://slashdot.org/story/19/12/16/2138213/amazon-blocks-sellers-from-using-fedex-ground-for-prime-shipments </url> <time>2019-12-16 22:50:00</time> <author>BeauHD</author> <department>tis-the-season</department> <topic>1971</topic> <comments>28</comments> <section>technology</section> <image>transportation_64.png</image> </story> <story> <title> Controversial Sale of<nobr> <wbr></nobr>.Org Domain Manager Faces Review At ICANN </title> <url> https://slashdot.org/story/19/12/16/2133236/controversial-sale-of-org-domain-manager-faces-review-at-icann </url> <time>2019-12-16 22:10:00</time> <author>BeauHD</author> <department>it's-not-a-done-deal-yet</department> <topic>94</topic> <comments>10</comments> <section>technology</section> <image>internet_64.png</image> </story> <story> <title> Boeing To Suspend Production of Their 737 Max Aircraft [Update] </title> <url> https://slashdot.org/story/19/12/16/0455249/boeing-to-suspend-production-of-their-737-max-aircraft-update </url> <time>2019-12-16 21:45:00</time> <author>EditorDavid</author> <department>no-fly-zone</department> <topic>1971</topic> <comments>137</comments> <section>technology</section> <image>transportation_64.png</image> </story> <story> <title> Wildfires Have Changed. It's Time the Science Did Too. </title> <url> https://slashdot.org/story/19/12/16/2051238/wildfires-have-changed-its-time-the-science-did-too </url> <time>2019-12-16 21:30:00</time> <author>msmash</author> <department>closer-look</department> <topic>209</topic> <comments>14</comments> <section>science</section> <image>usa_64.png</image> </story> <story> <title> Economists Got the Decade All Wrong. They're Trying To Figure Out Why. </title> <url> https://slashdot.org/story/19/12/16/2045245/economists-got-the-decade-all-wrong-theyre-trying-to-figure-out-why </url> <time>2019-12-16 20:50:00</time> <author>msmash</author> <department>closer-look</department> <topic>84</topic> <comments>169</comments> <section>news</section> <image>business_64.png</image> </story> <story> <title> Mark Cuban Sells Sports-Technology Company To Dodgers Owners </title> <url> https://slashdot.org/story/19/12/16/206204/mark-cuban-sells-sports-technology-company-to-dodgers-owners </url> <time>2019-12-16 20:10:00</time> <author>msmash</author> <department>how-about-that</department> <topic>84</topic> <comments>6</comments> <section>technology</section> <image>business_64.png</image> </story> <story> <title> Twitch Sued For $2.8B Over Alleged Pirated Streaming of Premier League Games </title> <url> https://slashdot.org/story/19/12/16/191229/twitch-sued-for-28b-over-alleged-pirated-streaming-of-premier-league-games </url> <time>2019-12-16 19:30:00</time> <author>msmash</author> <department>see-you-in-court</department> <topic>745</topic> <comments>25</comments> <section>yro</section> <image>piracy_64.png</image> </story> <story> <title> Google Warns Turkish Partners Over New Android Phones Amid Dispute </title> <url> https://slashdot.org/story/19/12/16/1850218/google-warns-turkish-partners-over-new-android-phones-amid-dispute </url> <time>2019-12-16 18:50:00</time> <author>msmash</author> <department>tussle-continues</department> <topic>11402</topic> <comments>14</comments> <section>technology</section> <image>android_64.png</image> </story> <story> <title>Amazon Learns a New Skill: Making Money From Alexa</title> <url> https://slashdot.org/story/19/12/16/1746231/amazon-learns-a-new-skill-making-money-from-alexa </url> <time>2019-12-16 18:10:00</time> <author>msmash</author> <department>makin'-money</department> <topic>84</topic> <comments>19</comments> <section>news</section> <image>business_64.png</image> </story> <story> <title> Why Won't Foxconn Tell Wisconsin What It's Building? </title> <url> https://slashdot.org/story/19/12/16/1717213/why-wont-foxconn-tell-wisconsin-what-its-building </url> <time>2019-12-16 17:30:00</time> <author>msmash</author> <department>stranger-things-season-4</department> <topic>209</topic> <comments>94</comments> <section>news</section> <image>usa_64.png</image> </story> </backslash>)";
				slashdot::parser slash;
				// DBG(raw);
				slash.parse(raw);
				if (slash.stories.empty()) {
					DBG("No stories.");
					return;
				}

				ui::window *win = parent->get_ui().new_window<ui::basic_window>("slashdot");
				parent->get_ui().focus_window(win);

				for (const slashdot::story &story: slash.stories) {
					DBG(story.title);
					*win += ansi::bold(story.title) + " (posted by " + ansi::underline(story.author) + " from the " +
							ansi::italic(story.department) + " dept.)";
					*win += "";
					*win += ansi::dim("...");
					*win += "";
					*win += "";
				}

				win->draw();
				slash.fetch();
				win->clear_lines();

				for (const slashdot::story &story: slash.stories) {
					*win += ansi::bold(story.title) + " (posted by " + ansi::underline(story.author) + " from the " +
							ansi::italic(story.department) + " dept.)";
					*win += "";
					for (const std::string &str: formicine::util::split(story.text, "\n", false))
						*win += lines::basic_line(parent, "    " + str, 4);
					*win += "";
					*win += "";
				}
			});

			thread.detach();
		});
	}

	void slashdot_plugin::cleanup(plugin_host *) {
		parent->remove_command(".");
	}
}

spjalla::plugins::slashdot_plugin ext_plugin {};
